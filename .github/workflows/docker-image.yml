name: Build and Publish Docker Image

on:
  push:
    branches:
      - Public
      - dev-interne

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Read version and define image name
        id: setup
        run: |
          branch=$(echo "${{ github.ref_name }}" | tr '[:upper:]' '[:lower:]')
          version_file="VERSION"

          if [ ! -f "$version_file" ]; then
            echo "âŒ Fichier VERSION manquant !"
            exit 1
          fi

          if [ "$branch" = "dev-interne" ]; then
            image_name="dev-jtheberg-vitrine"
            version=$(grep "^VERSION-dev=" VERSION | cut -d '=' -f2)
          elif [ "$branch" = "Public" ]; then
            image_name="jtheberg-vitrine"
            version=$(grep "^VERSION-prod=" VERSION | cut -d '=' -f2)
          else
            echo "âŒ Branche non supportÃ©e: $branch"
            exit 1
          fi

          owner_lower=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          echo "image_name=$image_name" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "owner_lower=$owner_lower" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        run: |
          IMAGE_VERSION=ghcr.io/${{ steps.setup.outputs.owner_lower }}/${{ steps.setup.outputs.image_name }}:${{ steps.setup.outputs.version }}
          IMAGE_LATEST=ghcr.io/${{ steps.setup.outputs.owner_lower }}/${{ steps.setup.outputs.image_name }}:latest

          echo "ðŸ“¦ Building image: $IMAGE_VERSION and tagging as latest"
          
          docker build -t $IMAGE_VERSION .
          docker tag $IMAGE_VERSION $IMAGE_LATEST

          echo "ðŸš€ Pushing versioned image: $IMAGE_VERSION"
          docker push $IMAGE_VERSION

          echo "ðŸš€ Pushing latest image: $IMAGE_LATEST"
          docker push $IMAGE_LATEST
